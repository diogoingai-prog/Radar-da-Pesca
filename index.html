<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Radar de Pesca</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
/* =======================
   RESET / BASE
======================= */
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: Arial, Helvetica, sans-serif; background:#0e1621; color:#fff; }

/* =======================
   MAPA
======================= */
#map { height: 100vh; width: 100vw; }

/* =======================
   PAINEL
======================= */
.panel {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: #111c2a;
  border-radius: 16px 16px 0 0;
  padding: 14px;
  max-height: 55vh;
  overflow-y: auto;
  box-shadow: 0 -4px 20px rgba(0,0,0,.4);
}

.panel h2 {
  font-size: 16px;
  margin-bottom: 8px;
}

.info {
  font-size: 14px;
  margin-bottom: 6px;
  opacity: .95;
}

.badge {
  display:inline-block;
  padding:2px 8px;
  border-radius:12px;
  font-size:12px;
  background:#1f6feb;
  margin-left:6px;
}

/* =======================
   BOT√ïES
======================= */
.controls {
  position: fixed;
  top: 12px;
  right: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.btn {
  background:#1f6feb;
  color:#fff;
  border:none;
  padding:10px 12px;
  border-radius:50%;
  cursor:pointer;
  font-size:16px;
}

.btn.loading span {
  display:inline-block;
  animation: rot 1s linear infinite;
}

@keyframes rot {
  from { transform: rotate(0deg); }
  to   { transform: rotate(360deg); }
}

/* =======================
   SPLASH
======================= */
#splash {
  position: fixed;
  inset: 0;
  background:#0e1621;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index: 9999;
}

#splash.hidden { display:none; }

@media(min-width: 769px){
  .panel { max-width: 420px; left: 12px; right: auto; bottom: 12px; border-radius:16px; }
}
</style>
</head>

<body>

<div id="map"></div>

<div id="splash">
  <h2>Carregando Radar de Pesca‚Ä¶</h2>
</div>

<div class="controls">
  <button id="btnGps" class="btn"><span>üìç</span></button>
</div>

<div class="panel">
  <h2 id="lbl-local">Localizando‚Ä¶</h2>
  <div class="info">üå°Ô∏è <span id="lbl-temp">--</span> ¬∞C</div>
  <div class="info">üí® Vento: <span id="lbl-vento">--</span> km/h</div>
  <div class="info">üåô Lua: <span id="lbl-lua">--</span></div>
  <div class="info">üåä Ambiente: <span id="lbl-rio">--</span></div>
  <div class="info">üêü Peixes indicados:</div>
  <div id="lista-peixes" class="info">--</div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =======================
   CONFIG
======================= */
const DEFAULT_POS = { lat: -18.5122, lng: -44.5550 }; // MG
const cache = new Map();

/* =======================
   MAPA
======================= */
const map = L.map('map').setView([DEFAULT_POS.lat, DEFAULT_POS.lng], 7);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '¬© OpenStreetMap'
}).addTo(map);

let marker = L.marker([DEFAULT_POS.lat, DEFAULT_POS.lng]).addTo(map);

/* =======================
   SPLASH
======================= */
const splash = document.getElementById('splash');
const SPLASH_TIMEOUT = setTimeout(() => fecharSplash(), 6000);
function fecharSplash(){
  clearTimeout(SPLASH_TIMEOUT);
  splash.classList.add('hidden');
}

/* =======================
   HELPERS
======================= */
async function fetchComCache(url, headers = {}) {
  if (cache.has(url)) return cache.get(url);
  const res = await fetch(url, { headers });
  const data = await res.json();
  cache.set(url, data);
  return data;
}

function getLua() {
  const diff = (Date.now() - new Date('2000-01-06').getTime()) / 86400000;
  const phase = Math.floor((diff % 29.53) / 7.38);
  return ["Nova","Crescente","Cheia","Minguante"][phase];
}

/* =======================
   CLIMA
======================= */
async function obterClima({lat,lng}) {
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true`;
  const d = await fetchComCache(url);
  return {
    temp: d.current_weather.temperature,
    vento: d.current_weather.windspeed
  };
}

/* =======================
   ENDERE√áO
======================= */
async function obterEndereco({lat,lng}) {
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
  const d = await fetchComCache(url, { "Accept-Language":"pt-BR" });
  return d.address?.city || d.address?.town || d.address?.state || "Local desconhecido";
}

/* =======================
   RIO / REPRESA (OVERPASS)
======================= */
async function detectarAmbiente(lat,lng) {
  const q = `
  [out:json][timeout:3];
  way["waterway"="river"](around:3000,${lat},${lng});
  out tags 1;
  `;
  const url = "https://overpass-api.de/api/interpreter?data=" + encodeURIComponent(q);
  const d = await fetchComCache(url);
  return d.elements.length ? "Rio" : "Represa / Lago";
}

/* =======================
   BANCO DE PEIXES
======================= */
const PEIXES_DB = [
  { nome:"Til√°pia", quente:true },
  { nome:"Tra√≠ra", quente:true },
  { nome:"Tucunar√©", quente:true },
  { nome:"Pacu", quente:false },
  { nome:"Dourado", quente:false }
];

function recomendarPeixes(temp) {
  return PEIXES_DB
    .filter(p => temp >= 22 ? p.quente : true)
    .map(p => p.nome)
    .join(", ");
}

/* =======================
   UI
======================= */
function atualizarUI({clima, local, ambiente}) {
  document.getElementById('lbl-local').innerText = local;
  document.getElementById('lbl-temp').innerText = clima.temp;
  document.getElementById('lbl-vento').innerText = clima.vento;
  document.getElementById('lbl-lua').innerText = getLua();
  document.getElementById('lbl-rio').innerText = ambiente;
  document.getElementById('lista-peixes').innerText =
    recomendarPeixes(clima.temp) || "Nenhuma recomenda√ß√£o";
}

/* =======================
   RADAR PRINCIPAL
======================= */
async function rodarRadar(coords) {
  try {
    marker.setLatLng([coords.lat, coords.lng]);
    map.setView([coords.lat, coords.lng], 13);

    const [clima, local, ambiente] = await Promise.all([
      obterClima(coords),
      obterEndereco(coords),
      detectarAmbiente(coords.lat, coords.lng)
    ]);

    atualizarUI({ clima, local, ambiente });
  } catch(e) {
    document.getElementById('lbl-rio').innerText = "Dados indispon√≠veis";
  } finally {
    fecharSplash();
  }
}

/* =======================
   GPS
======================= */
const btnGps = document.getElementById('btnGps');
btnGps.onclick = () => {
  btnGps.classList.add('loading');
  navigator.geolocation.getCurrentPosition(pos=>{
    btnGps.classList.remove('loading');
    rodarRadar({ lat: pos.coords.latitude, lng: pos.coords.longitude });
  }, ()=>{
    btnGps.classList.remove('loading');
    fecharSplash();
  });
};

/* =======================
   DEBOUNCE MAPA
======================= */
let radarTimeout;
map.on('moveend', ()=>{
  clearTimeout(radarTimeout);
  radarTimeout = setTimeout(()=>{
    const c = map.getCenter();
    rodarRadar({ lat:c.lat, lng:c.lng });
  }, 800);
});

/* =======================
   INIT
======================= */
rodarRadar(DEFAULT_POS);
</script>
</body>
</html>
