<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Radar da Pesca üì°</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --accent: #38bdf8; --bg: #0f172a; --card: #ffffff; --price: #16a34a; --status-red: #dc2626; --badge-green: #10b981; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; color: #1e293b; -webkit-tap-highlight-color: transparent; }
    
    /* SPLASH SCREEN */
    #splash { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease-out, visibility 0.8s; }
    .radar-container { position: relative; width: 220px; height: 220px; }
    .radar-rings circle { fill: none; stroke: rgba(56, 189, 248, 0.15); stroke-width: 1; }
    .radar-scan-line { transform-origin: 100px 100px; animation: scan-anim-reverse 4s linear infinite; }
    .radar-target { fill: var(--accent); animation: slow-pulse 3s ease-in-out infinite; }
    @keyframes scan-anim-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    @keyframes slow-pulse { 0%, 100% { opacity: 0.1; r: 1.5; } 50% { opacity: 0.9; r: 2.2; } }
    .splash-title { color: #fff; font-size: 26px; font-weight: 900; letter-spacing: 5px; margin: 25px 0 5px 0; text-align: center; }
    .splash-sub { color: var(--accent); font-size: 11px; font-weight: 600; text-transform: uppercase; text-align: center; padding: 0 25px; opacity: 0.8; }

    /* MAPA & UI */
    #map { height: 100vh; width: 100vw; z-index: 1; background: #e5e7eb; }
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none; opacity: 0.6; color: #0f172a; display: flex; align-items: center; justify-content: center; }
    .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 2000; }
    .search-box { background: #fff; border-radius: 25px; padding: 10px 18px; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
    .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 15px; color: #475569; font-weight: 500; }
    
    .gps-btn { position: absolute; bottom: 280px; right: 20px; z-index: 2500; background: #fff; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #e0f2fe; color: #1d4ed8; cursor: pointer; transition: transform 0.2s; }
    .gps-btn:active { transform: scale(0.95); }
    .gps-btn.loading { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* GAVETA (DRAWER) */
    .drawer { 
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 2000; 
      background: var(--card); border-radius: 24px 24px 0 0; 
      box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
      height: 230px; max-height: 94vh;
      transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1); 
      display: flex; flex-direction: column; overflow: hidden;
      touch-action: none;
    }
    .drawer.open { height: 94vh; }
    .drawer.dragging { transition: none; }
    .handle { height: 32px; width: 100%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: grab; }
    .handle-bar { width: 45px; height: 5px; background: #e2e8f0; border-radius: 10px; }

    /* CONTE√öDO DA GAVETA */
    .summary { padding: 0 20px 10px 20px; flex-shrink: 0; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .status-badge { font-size: 9px; font-weight: 800; color: var(--status-red); text-transform: uppercase; display: flex; align-items: center; gap: 4px; }
    /* REMOVIDO: .water-badge */
    
    .city-label { font-size: 20px; font-weight: 800; color: #0f172a; margin: 0 0 10px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

    .env-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
    .env-box { background: #f8fafc; padding: 8px; border-radius: 12px; text-align: center; border: 1px solid #f1f5f9; }
    .env-lbl { display: block; font-size: 9px; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
    .env-val { font-size: 13px; font-weight: 800; color: #0f172a; display: flex; align-items: center; justify-content: center; gap: 4px; }

    .top3-row { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; min-height: 38px; margin-bottom: 15px; padding-bottom: 5px; }
    .fish-chip { background: #0f172a; color: #fff; padding: 8px 14px; border-radius: 12px; display: flex; align-items: center; gap: 6px; white-space: nowrap; font-size: 11px; font-weight: 600; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.2); }
    .fish-chip .score-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--badge-green); }

    .details-title { font-size: 11px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin: 0 20px 15px 20px; border-top: 1px solid #f1f5f9; padding-top: 15px; flex-shrink: 0; }
    .scroll-area { overflow-y: auto; flex: 1; background: #fff; -webkit-overflow-scrolling: touch; padding: 0 20px 100px 20px; touch-action: pan-y; }

    /* √ÅREA DE PROPAGANDA */
    .ad-slot {
      width: 100%;
      height: 100px;
      background: #f1f5f9;
      border: 2px dashed #cbd5e1;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      color: #94a3b8;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .fish-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .fish-name { font-weight: 800; font-size: 16px; color: #0f172a; }
    .match-tag { font-size: 9px; font-weight: 800; background: #ecfccb; color: #4d7c0f; padding: 4px 8px; border-radius: 6px; }
    
    .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .tech-item { background: #f8fafc; padding: 8px 12px; border-radius: 8px; border-left: 3px solid var(--accent); }
    .tech-item.gold { border-left-color: #f59e0b; background: #fffbeb; }
    .tech-lbl { display: block; font-size: 8px; font-weight: 800; color: #64748b; text-transform: uppercase; margin-bottom: 2px; }
    .tech-val { font-size: 11px; font-weight: 700; color: #334155; line-height: 1.3; }
    
    .footer-msg { text-align: center; padding: 30px 20px; color: #cbd5e1; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
  </style>
</head>
<body>

  <div id="splash">
    <div class="radar-container">
      <svg viewBox="0 0 200 200" width="220" height="220">
        <g class="radar-rings"><circle cx="100" cy="100" r="98"/><circle cx="100" cy="100" r="75"/><circle cx="100" cy="100" r="50"/></g>
        <circle cx="135" cy="65" r="2.2" class="radar-target" />
        <g class="radar-scan-line"><path d="M 100 100 L 100 0 A 100 100 0 0 1 200 100 Z" fill="rgba(56, 189, 248, 0.2)"/><line x1="100" y1="100" x2="100" y2="0" stroke="#38bdf8" stroke-width="2.5"/></g>
      </svg>
    </div>
    <h1 class="splash-title">RADAR DA PESCA</h1>
    <p class="splash-sub">Calibrando sensores hidrost√°ticos...</p>
  </div>

  <div class="top-bar">
    <div class="search-box">
      <span class="material-icons" style="color:#94a3b8">search</span>
      <input type="text" id="search-input" class="search-input" placeholder="Buscar cidade, rio ou represa..." onkeypress="if(event.key==='Enter') buscarManual()">
      <button onclick="buscarManual()" style="background:none; border:none; font-weight:900; color:#0f172a; cursor:pointer;">IR</button>
    </div>
  </div>
  
  <div class="gps-btn" id="gps-btn" onclick="iniciarGPS()"><span class="material-icons">my_location</span></div>
  
  <div id="map"></div>
  <div class="crosshair"><span class="material-icons" style="font-size: 28px;">add</span></div>

  <div class="drawer" id="painel">
    <div class="handle" id="drawer-handle"><div class="handle-bar"></div></div>
    
    <div class="summary" id="drawer-summary">
      <div class="header-row">
        <div class="status-badge"><span class="material-icons" style="font-size:12px;">sensors</span> RADAR ATIVO</div>
        </div>
      <h2 class="city-label" id="lbl-cidade">üìç Aguardando sat√©lite...</h2>
      
      <div class="env-grid">
        <div class="env-box"><span class="env-lbl">Temp. Ar</span><span class="env-val" id="val-temp">--</span></div>
        <div class="env-box"><span class="env-lbl">Vento</span><span class="env-val" id="val-vento">--</span></div>
        <div class="env-box"><span class="env-lbl">Lua Hoje</span><span class="env-val" id="val-lua">--</span></div>
        <div class="env-box"><span class="env-lbl">Press√£o</span><span class="env-val" id="val-press">--</span></div>
        <div class="env-box"><span class="env-lbl">Chuva (mm)</span><span class="env-val" id="val-rain">--</span></div>
        <div class="env-box"><span class="env-lbl">Humidade</span><span class="env-val" id="val-hum">--</span></div>
      </div>
      
      <div class="top3-row" id="container-top3">
        </div>
    </div>
    
    <div class="details-title">An√°lise T√©cnica & Estrat√©gia</div>
    
    <div class="scroll-area" id="scroll-content">
      
      <div class="ad-slot">
        Publicidade Google AdSense
      </div>
      
      <div id="lista-detalhada"></div>
      <div class="footer-msg">Radar da Pesca ‚Ä¢ Tecnologia Diogo Ingai</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // --- MAPA ---
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-15.7, -47.9], 5);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

    let lastCoords = { lat: 0, lng: 0 };
    
    // Mapeamento de Estados expandido
    const UF_MAP = {"Acre":"AC","Alagoas":"AL","Amap√°":"AP","Amazonas":"AM","Bahia":"BA","Cear√°":"CE","Distrito Federal":"DF","Esp√≠rito Santo":"ES","Goi√°s":"GO","Maranh√£o":"MA","Mato Grosso":"MT","Mato Grosso do Sul":"MS","Minas Gerais":"MG","Par√°":"PA","Para√≠ba":"PB","Paran√°":"PR","Pernambuco":"PE","Piau√≠":"PI","Rio de Janeiro":"RJ","Rio Grande do Norte":"RN","Rio Grande do Sul":"RS","Rond√¥nia":"RO","Roraima":"RR","Santa Catarina":"SC","S√£o Paulo":"SP","Sergipe":"SE","Tocantins":"TO"};

    // Base de Dados de Peixes (LISTA COMPLETA 38 PEIXES)
    const PEIXES_DB = [
      // === BAGRES / COURO ===
      { id: 'pintado', nome: "Pintado / Surubim", bacia: ["Paran√°","S√£o Francisco","Geral"], isca: "Tuvira, Minhocu√ßu, Peda√ßos", idealT: 25, h: "Noite/Madrugada", prof: "Fundo", p: "Po√ßos fundos, Canais", vara: "50lb Pesada", linha: "0.50mm Mono" },
      { id: 'cachara', nome: "Cachara", bacia: ["Amazonas","Geral","Paran√°"], isca: "Tuvira, Lambari, Iscas Artificiais", idealT: 26, h: "Crep√∫sculo", prof: "Meia-√°gua/Fundo", p: "Barrancos, Estruturas", vara: "40lb M√©dia-Pesada", linha: "0.45mm Mono" },
      { id: 'pirarara', nome: "Pirarara", bacia: ["Amazonas","Geral"], isca: "Cabe√ßa de peixe, Carne, Queijo", idealT: 27, h: "Qualquer hora", prof: "Fundo", p: "Po√ßos, Galhadas", vara: "80lb Pesada", linha: "0.70mm Mono" },
      { id: 'jau', nome: "Ja√∫", bacia: ["Paran√°","Amazonas","S√£o Francisco"], isca: "Piau inteiro, Tuvira grande", idealT: 25, h: "Noite", prof: "Fundo Pedras", p: "Po√ßos profundos", vara: "100lb Extra Pesada", linha: "0.90mm Mono" },
      { id: 'jurupoca', nome: "Jurupoca", bacia: ["Paran√°","S√£o Francisco"], isca: "Minhoca, Tuvira pequena", idealT: 22, h: "Fim de tarde", prof: "Fundo", p: "Bocas de lagoa", vara: "20lb M√©dia", linha: "0.35mm Mono" },
      { id: 'mandi', nome: "Mandi", bacia: ["Geral"], isca: "Minhoca, Queijo", idealT: 24, h: "Chuva/Noite", prof: "Fundo", p: "Areia/Lodo", vara: "12lb Leve", linha: "0.25mm Mono" },
      { id: 'piraiba', nome: "Pira√≠ba", bacia: ["Amazonas"], isca: "Peixes inteiros", idealT: 27, h: "Dia/Noite", prof: "Canal do Rio", p: "Fundo", vara: "120lb Guincho", linha: "1.00mm Mono" },
      { id: 'barbado', nome: "Barbado", bacia: ["Paran√°","Amazonas"], isca: "Peda√ßos de peixe, Tuvira", idealT: 25, h: "Dia/Noite", prof: "Fundo", p: "Po√ßos, Canais", vara: "40lb Pesada", linha: "0.50mm Mono" },

      // === ESCAMA / PREDADORES ===
      { id: 'dourado', nome: "Dourado", bacia: ["Paran√°","S√£o Francisco","Geral"], isca: "Tuvira, Isca Artificial", idealT: 24, h: "Sol forte", prof: "Corredeira", p: "Pedreiras, Corredeiras", vara: "40lb R√°pida", linha: "0.40mm Multi" },
      { id: 'tucunare_azul', nome: "Tucunar√© Azul", bacia: ["Paran√°","Geral","Sudeste"], isca: "Zara, Stick, Jig", idealT: 27, h: "Sol a pino", prof: "0.5-3m", p: "Galhadas, Estruturas", vara: "20lb R√°pida", linha: "0.28mm Multi" },
      { id: 'tucunare_amarelo', nome: "Tucunar√© Amarelo", bacia: ["Geral","Sudeste"], isca: "Spinner, Lambari, Jig", idealT: 24, h: "Dia todo", prof: "Raso", p: "Margens, Capim", vara: "14lb R√°pida", linha: "0.20mm Multi" },
      { id: 'tucunare_acu', nome: "Tucunar√© A√ßu", bacia: ["Amazonas"], isca: "H√©lices Grandes, Popper", idealT: 29, h: "Sol forte", prof: "Superf√≠cie", p: "Ressacas, Praias", vara: "30lb R√°pida", linha: "0.50mm Multi" },
      { id: 'traira', nome: "Tra√≠ra", bacia: ["Geral"], isca: "Frog, Lambari, Spinner", idealT: 23, h: "Crep√∫sculo", prof: "Raso/Mato", p: "Vegeta√ß√£o, Aguap√©s", vara: "20lb R√°pida", linha: "0.30mm Multi" },
      { id: 'trairao', nome: "Trair√£o", bacia: ["Amazonas"], isca: "Iscas Grandes Superf√≠cie", idealT: 28, h: "Dia/Noite", prof: "Raso", p: "Remansos, Pedras", vara: "50lb Pesada", linha: "0.60mm Multi" },
      { id: 'matrinxa', nome: "Matrinx√£", bacia: ["Geral","Amazonas"], isca: "Frutas, Colheres, Lambari", idealT: 26, h: "Dia", prof: "Corredeira", p: "Embaixo de √°rvores", vara: "17lb M√©dia", linha: "0.30mm Mono" },
      { id: 'piraputanga', nome: "Piraputanga", bacia: ["Paran√°","Geral"], isca: "Frutas, Pequenos Plugs", idealT: 25, h: "Dia (√Ågua Clara)", prof: "Raso", p: "Cardumes vis√≠veis", vara: "14lb Leve", linha: "0.25mm Mono" },
      { id: 'apapa', nome: "Apap√° / Dourada", bacia: ["Amazonas"], isca: "Iscas Superf√≠cie, Colher", idealT: 28, h: "Fim de tarde", prof: "Superf√≠cie", p: "Canais", vara: "20lb M√©dia", linha: "0.30mm Multi" },
      { id: 'aruana', nome: "Aruan√£", bacia: ["Amazonas"], isca: "Insetos, Iscas pequenas", idealT: 28, h: "Dia", prof: "Superf√≠cie", p: "Beiradas", vara: "17lb M√©dia", linha: "0.25mm Multi" },
      { id: 'bicuda', nome: "Bicuda", bacia: ["Amazonas"], isca: "Colheres, Plugs r√°pidos", idealT: 28, h: "Sol forte", prof: "Corredeira", p: "Bicos de pedra", vara: "20lb R√°pida", linha: "0.30mm Multi" },
      { id: 'cachorro', nome: "Cachorro", bacia: ["Amazonas"], isca: "Iscas Meia-√°gua", idealT: 27, h: "Dia", prof: "Corredeira", p: "Cachoeiras", vara: "30lb Pesada", linha: "0.40mm Multi" },
      { id: 'jacunda', nome: "Jacund√°", bacia: ["Geral"], isca: "Spinners, Iscas pequenas", idealT: 25, h: "Dia", prof: "Raso", p: "Margens", vara: "10lb Leve", linha: "0.20mm Multi" },
      { id: 'apaiari', nome: "Apaiari / Oscar", bacia: ["Amazonas","Nordeste"], isca: "Insetos, Spinners", idealT: 27, h: "Dia", prof: "√Ågua parada", p: "Lagoas", vara: "12lb Leve", linha: "0.25mm Multi" },
      { id: 'blackbass', nome: "Black Bass", bacia: ["Sul","Sudeste"], isca: "Minhoca Artificial, Jig", idealT: 20, h: "Dia", prof: "Estruturas", p: "Troncos, Piers", vara: "14lb R√°pida", linha: "0.25mm Fluor" },
      { id: 'truta', nome: "Truta Arco-√çris", bacia: ["Sul","Sudeste"], isca: "Fly, Spinners, Massa", idealT: 14, h: "Dia", prof: "Corredeira", p: "√Ågua fria/limpa", vara: "Ultra Leve / Fly", linha: "0.18mm Mono" },
      { id: 'piranha', nome: "Piranha", bacia: ["Geral"], isca: "Carne, Sangue, F√≠gado", idealT: 26, h: "Dia", prof: "Meia-√°gua", p: "Remansos, Cevas", vara: "20lb (Cabo A√ßo)", linha: "0.30mm Multi" },

      // === REDONDOS / OUTROS ===
      { id: 'pacu', nome: "Pacu", bacia: ["Paran√°","Geral"], isca: "Coquinho, Massa, Caranguejo", idealT: 25, h: "Dia", prof: "Meia/Fundo", p: "Embaixo de √°rvores", vara: "25lb M√©dia", linha: "0.40mm Mono" },
      { id: 'tambaqui', nome: "Tambaqui", bacia: ["Amazonas","Geral"], isca: "Salsicha, Beijinho, Frutas", idealT: 28, h: "Dia todo", prof: "Superf√≠cie/Meia", p: "Lagos, Pesqueiros", vara: "40lb Pesada", linha: "0.50mm Mono" },
      { id: 'tambacu', nome: "Tambacu", bacia: ["Geral","Sudeste"], isca: "Ra√ß√£o, Massa, Salsicha", idealT: 24, h: "Dia", prof: "Fundo/Meia", p: "Pesqueiros", vara: "30lb Pesada", linha: "0.45mm Mono" },
      { id: 'piapara', nome: "Piapara", bacia: ["Paran√°","Geral"], isca: "Milho, Caranguejo, Massa", idealT: 23, h: "Dia", prof: "Fundo", p: "Cevas", vara: "17lb Sens√≠vel", linha: "0.30mm Mono" },
      { id: 'piaucu', nome: "Piau√ßu", bacia: ["Geral","Paran√°"], isca: "Caranguejo, Milho, Caramujo", idealT: 25, h: "Dia", prof: "Fundo", p: "Margens, Capim", vara: "25lb M√©dia", linha: "0.40mm Mono" },
      { id: 'piau3', nome: "Piau Tr√™s Pintas", bacia: ["Geral"], isca: "Milho verde, Massa", idealT: 24, h: "Dia", prof: "Raso/Fundo", p: "Corredeiras", vara: "12lb Leve", linha: "0.25mm Mono" },
      { id: 'piau_flamengo', nome: "Piau Flamengo", bacia: ["Amazonas","Geral"], isca: "Milho, Massa", idealT: 26, h: "Dia", prof: "Margem", p: "Barrancos", vara: "14lb Leve", linha: "0.28mm Mono" },
      { id: 'curimba', nome: "Curimbat√° (Curimba)", bacia: ["Geral"], isca: "Massa doce, Milho", idealT: 22, h: "Dia", prof: "Fundo", p: "Barro", vara: "15lb M√©dia", linha: "0.30mm Mono" },
      { id: 'curimata', nome: "Curimat√£-Pacu", bacia: ["S√£o Francisco"], isca: "Massa doce", idealT: 26, h: "Dia", prof: "Fundo", p: "Po√ßos", vara: "25lb M√©dia", linha: "0.40mm Mono" },
      { id: 'tilapia', nome: "Til√°pia", bacia: ["Geral"], isca: "Massa, Ra√ß√£o, Minhoca", idealT: 25, h: "Manh√£/Tarde", prof: "1-3m", p: "Margens", vara: "10lb Leve", linha: "0.25mm Mono" },
      { id: 'pirarucu', nome: "Pirarucu", bacia: ["Amazonas"], isca: "Peixe vivo, Isca Soft", idealT: 30, h: "Subida (Respira√ß√£o)", prof: "Superf√≠cie/Fundo", p: "Lagos parados", vara: "80lb Extra Pesada", linha: "0.80mm Multi" },
      { id: 'corvina', nome: "Corvina", bacia: ["Amazonas","Paran√°"], isca: "Camar√£o, Lambari, Jig", idealT: 24, h: "Dia/Noite", prof: "Fundo", p: "Po√ßos, Estruturas", vara: "17lb M√©dia", linha: "0.30mm Mono" }
    ];

    // --- L√ìGICA DA GAVETA (TOUCH + MOUSE) ---
    const drawer = document.getElementById('painel');
    const scrollContent = document.getElementById('scroll-content');
    const handle = document.getElementById('drawer-handle');
    let startY = 0, startH = 0, isDragging = false;
    const minH = 230, maxH = window.innerHeight * 0.94;

    const getClientY = (e) => e.touches ? e.touches[0].clientY : e.clientY;

    const startDrag = (e) => {
      if (drawer.offsetHeight >= maxH - 10 && scrollContent.scrollTop > 0 && e.target !== handle && !handle.contains(e.target)) return;
      startY = getClientY(e); 
      startH = drawer.offsetHeight; 
      isDragging = true;
      drawer.classList.add('dragging');
    };

    const onDrag = (e) => {
      if (!isDragging) return;
      const clientY = getClientY(e);
      const deltaY = startY - clientY; 
      if (startH >= maxH - 10 && deltaY > 0) return;
      let newH = startH + deltaY;
      if (newH > maxH) newH = maxH + (newH - maxH) * 0.1;
      if (newH < minH) newH = minH - (minH - newH) * 0.2;
      drawer.style.height = `${newH}px`;
      if (e.cancelable && e.type === 'touchmove') e.preventDefault(); 
    };

    const endDrag = () => {
      isDragging = false;
      drawer.classList.remove('dragging');
      if (drawer.offsetHeight > minH + 100) { 
        drawer.style.height = `${maxH}px`; 
        drawer.classList.add('open'); 
      } else { 
        drawer.style.height = `${minH}px`; 
        drawer.classList.remove('open'); 
        scrollContent.scrollTop = 0; 
      }
    };

    drawer.addEventListener('touchstart', startDrag, { passive: true });
    window.addEventListener('touchmove', onDrag, { passive: false });
    window.addEventListener('touchend', endDrag);

    drawer.addEventListener('mousedown', startDrag);
    window.addEventListener('mousemove', onDrag);
    window.addEventListener('mouseup', endDrag);

    // --- L√ìGICA DO RADAR ---
    function getMoonData() {
      const lp = 2551443; 
      const now = new Date();
      const new_moon = new Date(1970, 0, 7, 20, 35, 0);
      const phase = ((now.getTime() - new_moon.getTime()) / 1000) % lp;
      const age = Math.floor(phase / (24 * 3600)) + 1;
      if (age <= 3) return {n: "Nova", i: "üåë"}; 
      if (age <= 10) return {n: "Crescente", i: "üåì"};
      if (age <= 17) return {n: "Cheia", i: "üåï"}; 
      return {n: "Minguante", i: "üåó"};
    }

    function getWeatherIcon(code) {
      if(code <= 3) return "‚òÄÔ∏è"; 
      if(code <= 67) return "üåßÔ∏è"; 
      if(code >= 95) return "‚õàÔ∏è"; 
      return "‚òÅÔ∏è";
    }

    async function rodarRadar(coords, preLoadedAddress = null) {
      if (!preLoadedAddress && Math.abs(coords.lat - lastCoords.lat) < 0.005) return;
      lastCoords = coords;
      
      try {
        let addr = preLoadedAddress;
        
        // Se n√£o veio o endere√ßo pronto, busca agora (mas evita se poss√≠vel)
        if (!addr) {
           const resGeo = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`).then(r => r.json());
           addr = resGeo.address || {};
        }

        const pWeather = fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,precipitation,weathercode&timezone=auto`).then(r => r.json());
        const resW = await pWeather;
        
        const fullAddr = JSON.stringify(addr).toLowerCase();
        const uf = UF_MAP[addr.state] || "BR";
        const cid = addr.city || addr.town || addr.village || addr.municipality || "Local Remoto";
        
        document.getElementById('lbl-cidade').innerText = `üìç ${cid}-${uf}`;

        let bacia = "Geral";
        if (fullAddr.includes("amazon") || ["AM","PA","RO","RR","AC","AP","MT","TO"].includes(uf)) bacia = "Amazonas";
        else if (fullAddr.includes("francisco") || ["MG","BA","PE","AL","SE"].includes(uf)) bacia = "S√£o Francisco";
        else if (fullAddr.includes("parana") || fullAddr.includes("tiet") || ["MS","PR","SP","SC","RS","GO","DF","RJ","ES"].includes(uf)) bacia = "Paran√°";

        // NOTA: O badge visual foi removido, mas a l√≥gica 'bacia' continua usada abaixo para o filtro.

        const cur = resW.current;
        const moon = getMoonData();
        const wIcon = getWeatherIcon(cur.weathercode);

        document.getElementById('val-temp').innerHTML = `${wIcon} ${Math.round(cur.temperature_2m)}¬∞C`;
        document.getElementById('val-vento').innerText = `${Math.round(cur.wind_speed_10m)} km/h`;
        document.getElementById('val-press').innerText = `${Math.round(cur.surface_pressure)} hPa`;
        document.getElementById('val-lua').innerText = `${moon.i} ${moon.n}`;
        document.getElementById('val-hum').innerText = `${cur.relative_humidity_2m}%`;
        document.getElementById('val-rain').innerText = `${cur.precipitation} mm`;

        const top3C = document.getElementById('container-top3');
        const listC = document.getElementById('lista-detalhada');
        top3C.innerHTML = ''; listC.innerHTML = '';
        
        const sortedFish = PEIXES_DB.filter(p => p.bacia.includes(bacia) || p.bacia.includes("Geral"))
        .map(p => {
          let score = 80; 
          score -= Math.abs(cur.temperature_2m - p.idealT) * 3;
          if(moon.n === "Cheia") score += 5;
          if(cur.surface_pressure > 1010) score += 5;
          return {...p, score: Math.min(100, Math.max(0, Math.round(score)))};
        }).sort((a,b) => b.score - a.score);

        sortedFish.slice(0,3).forEach(p => {
          top3C.innerHTML += `
            <div class="fish-chip">
              <div class="score-dot" style="background:${p.score > 70 ? '#10b981' : '#f59e0b'}"></div>
              ${p.nome}
            </div>`;
        });

        if(sortedFish.length === 0) {
            listC.innerHTML = '<div style="text-align:center; color:#94a3b8; padding:20px;">Nenhum peixe espec√≠fico mapeado para esta regi√£o ainda.</div>';
        } else {
            sortedFish.forEach(p => {
              const matchColor = p.score > 80 ? '#dcfce7' : (p.score > 50 ? '#fef3c7' : '#fee2e2');
              const matchTextC = p.score > 80 ? '#166534' : (p.score > 50 ? '#92400e' : '#991b1b');
              
              listC.innerHTML += `
                <div class="fish-card">
                  <div class="card-header">
                    <span class="fish-name">${p.nome}</span>
                    <span class="match-tag" style="background:${matchColor}; color:${matchTextC};">
                      CHANCE: ${p.score}%
                    </span>
                  </div>
                  <div class="tech-grid">
                    <div class="tech-item gold" style="grid-column: span 2;">
                      <span class="tech-lbl">üéØ Isca Matadeira</span>
                      <span class="tech-val">${p.isca}</span>
                    </div>
                    <div class="tech-item"><span class="tech-lbl">‚è∞ Hor√°rio</span><span class="tech-val">${p.h}</span></div>
                    <div class="tech-item"><span class="tech-lbl">üåä Profundidade</span><span class="tech-val">${p.prof}</span></div>
                    <div class="tech-item"><span class="tech-lbl">üé£ Equipamento</span><span class="tech-val">${p.vara}</span></div>
                    <div class="tech-item"><span class="tech-lbl">üßµ Linha/Leader</span><span class="tech-val">${p.linha}</span></div>
                  </div>
                </div>`;
            });
        }
        
        fecharSplash();
      } catch (e) { 
        console.error(e);
        fecharSplash(); 
      }
    }

    function fecharSplash() {
      const s = document.getElementById('splash');
      if(s && s.style.opacity !== '0') { 
        s.style.opacity = '0'; 
        setTimeout(() => s.style.display = 'none', 800); 
      }
    }

    function iniciarGPS() {
      const btn = document.getElementById('gps-btn');
      btn.classList.add('loading');
      
      navigator.geolocation.getCurrentPosition((pos) => {
        btn.classList.remove('loading');
        const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.flyTo([c.lat, c.lng], 13); 
        rodarRadar(c);
      }, (err) => { 
        btn.classList.remove('loading');
        // alert("GPS indispon√≠vel. Usando localiza√ß√£o padr√£o."); // Alert removido para ser menos intrusivo
        rodarRadar(map.getCenter());
        fecharSplash(); 
      }, { timeout: 10000 });
    }
    
    function buscarManual() {
      const q = document.getElementById('search-input').value;
      if(!q) return;
      const btn = document.querySelector('.search-box button');
      btn.innerText = '...';
      document.getElementById('lbl-cidade').innerText = 'üìç Carregando...'; // Feedback visual imediato

      // Otimiza√ß√£o: Pede 'addressdetails=1' para n√£o precisar buscar de novo depois
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Brazil&addressdetails=1`).then(r => r.json()).then(data => {
        btn.innerText = 'IR';
        if(data[0]) { 
          const c = {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)}; 
          map.setView([c.lat, c.lng], 12); 
          // Passa o endere√ßo direto para economizar tempo
          rodarRadar(c, data[0].address); 
          drawer.style.height = '60vh';
        } else {
          alert("Local n√£o encontrado!");
          document.getElementById('lbl-cidade').innerText = 'üìç Tente novamente';
        }
      }).catch(() => btn.innerText = 'IR');
    }

    window.onload = () => { 
      iniciarGPS(); 
      setTimeout(fecharSplash, 6000); 
    };
  </script>
</body>
</html>
