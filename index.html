<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Radar da Pesca 游니</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --accent: #0ea5e9; --bg: #0f172a; --card: #ffffff; --text: #1e293b; --green: #16a34a; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; color: var(--text); -webkit-tap-highlight-color: transparent; }
    
    /* SPLASH */
    #splash { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
    .loader { width: 48px; height: 48px; border: 5px solid #fff; border-bottom-color: var(--accent); border-radius: 50%; animation: rot 1s linear infinite; }
    @keyframes rot { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .splash-txt { color: #fff; margin-top: 20px; font-weight: 600; letter-spacing: 1px; font-size: 14px; }

    /* UI MAPA */
    #map { height: 100vh; width: 100vw; z-index: 1; background: #e5e7eb; }
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none; color: #0f172a; }
    
    .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 2000; }
    .search-box { background: #fff; border-radius: 25px; padding: 12px 20px; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
    .search-input { border: none; outline: none; width: 100%; font-size: 16px; color: #334155; }
    
    .gps-btn { position: absolute; bottom: 320px; right: 20px; z-index: 2500; background: #fff; width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 15px rgba(0,0,0,0.2); color: var(--accent); cursor: pointer; }
    .gps-btn.loading { animation: rot 1s linear infinite; }

    /* GAVETA */
    .drawer { 
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 2000; 
      background: var(--card); border-radius: 24px 24px 0 0; 
      box-shadow: 0 -10px 40px rgba(0,0,0,0.2); 
      height: 300px; max-height: 92vh; 
      display: flex; flex-direction: column; 
      transition: height 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    .drawer.open { height: 85vh; }
    
    .handle-area { height: 30px; width: 100%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: grab; touch-action: none; }
    .handle-bar { width: 40px; height: 5px; background: #cbd5e1; border-radius: 10px; }

    .summary { padding: 5px 20px 15px 20px; flex-shrink: 0; }
    .status-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .status-badge { font-size: 10px; font-weight: 800; color: var(--green); display: flex; align-items: center; gap: 4px; }
    .bacia-badge { font-size: 9px; font-weight: 700; background: #e2e8f0; color: #475569; padding: 3px 8px; border-radius: 6px; }

    .city-label { font-size: 22px; font-weight: 800; color: #0f172a; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; line-height: 1.2; }
    .river-tag { font-size: 11px; color: var(--accent); font-weight: 700; display: block; margin-bottom: 15px; text-transform: uppercase; }

    .env-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
    .env-box { background: #f8fafc; padding: 8px; border-radius: 12px; text-align: center; border: 1px solid #e2e8f0; }
    .env-val { font-size: 13px; font-weight: 800; color: #0f172a; display: block; }
    .env-lbl { font-size: 9px; font-weight: 600; color: #64748b; text-transform: uppercase; }

    .top-picks { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none; }
    .chip { background: #0f172a; color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; white-space: nowrap; display: flex; align-items: center; gap: 6px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; }

    .content-area { flex: 1; overflow-y: auto; padding: 0 20px 40px 20px; -webkit-overflow-scrolling: touch; }
    .list-title { font-size: 12px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin: 20px 0 10px 0; letter-spacing: 1px; }

    .fish-card { background: #fff; border: 1px solid #e2e8f0; border-radius: 16px; padding: 16px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
    .card-head { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .f-name { font-size: 18px; font-weight: 800; color: #0f172a; }
    .f-score { font-size: 11px; font-weight: 700; background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 6px; }
    
    .tech-info { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .info-box { background: #f8fafc; padding: 8px; border-radius: 8px; }
    .ib-lbl { font-size: 9px; font-weight: 700; color: #64748b; display: block; margin-bottom: 2px; }
    .ib-val { font-size: 12px; font-weight: 600; color: #334155; line-height: 1.3; }
    
    .ad-box { margin: 10px 0 20px 0; height: 80px; background: #f1f5f9; border: 2px dashed #cbd5e1; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: #94a3b8; font-size: 10px; font-weight: 700; letter-spacing: 1px; }
  </style>
</head>
<body>

  <div id="splash">
    <div class="loader"></div>
    <div class="splash-txt">CALIBRANDO RADAR...</div>
  </div>

  <div class="top-bar">
    <div class="search-box">
      <span class="material-icons" style="color:#94a3b8">search</span>
      <input type="text" id="search-input" class="search-input" placeholder="Buscar cidade ou rio..." onkeypress="if(event.key==='Enter') buscarManual()">
      <span class="material-icons" onclick="buscarManual()" style="color:#0f172a; cursor:pointer;">arrow_forward</span>
    </div>
  </div>

  <div class="gps-btn" id="gps-btn" onclick="usarGPS()"><span class="material-icons">my_location</span></div>
  <div id="map"></div>
  <div class="crosshair"><span class="material-icons" style="font-size:32px; opacity:0.7;">add</span></div>

  <div class="drawer" id="painel">
    <div class="handle-area" id="drag-handle"><div class="handle-bar"></div></div>
    
    <div class="summary">
      <div class="status-row">
        <div class="status-badge"><span class="material-icons" style="font-size:14px;">sensors</span> ONLINE</div>
        <div id="badge-bacia" class="bacia-badge">GERAL</div>
      </div>
      <h1 class="city-label" id="lbl-cidade">Localizando...</h1>
      <span class="river-tag" id="lbl-rio"></span>

      <div class="env-grid">
        <div class="env-box"><span class="env-lbl">Clima</span><span class="env-val" id="val-temp">--</span></div>
        <div class="env-box"><span class="env-lbl">Vento</span><span class="env-val" id="val-vento">--</span></div>
        <div class="env-box"><span class="env-lbl">Fase Lua</span><span class="env-val" id="val-lua">--</span></div>
        <div class="env-box"><span class="env-lbl">Press칚o</span><span class="env-val" id="val-press">--</span></div>
        <div class="env-box"><span class="env-lbl">Chuva</span><span class="env-val" id="val-chuva">--</span></div>
        <div class="env-box"><span class="env-lbl">Umidade</span><span class="env-val" id="val-hum">--</span></div>
      </div>

      <div class="top-picks" id="chips-container"></div>
    </div>

    <div class="content-area">
      <div class="ad-box">PUBLICIDADE GOOGLE</div>
      <div class="list-title">An치lise Completa</div>
      <div id="lista-peixes"></div>
      <div style="text-align:center; padding:30px; color:#cbd5e1; font-size:10px;">RADAR DA PESCA V12.0</div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    // --- MAPA ---
    const map = L.map('map', { zoomControl: false }).setView([-15.7, -47.9], 5);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

    let lastLat = 0, lastLng = 0;
    
    // --- BANCO DE DADOS INTELIGENTE ---
    // 'regiao': Onde o peixe costuma estar (Sul_MG, Norte_MG, Geral, etc)
    // 'tipo_agua': Onde ele prefere (Rio, Represa, Geral)
    const PEIXES_DB = [
      { id: 'dourado', nome: "Dourado", regiao: ["Sul_MG","Paran치","S칚o Francisco"], tipo_agua: "Rio", isca: "Tuvira, Artificial", equip: "Vara 40lb", h: "Sol forte", p: "Corredeiras" },
      { id: 'pintado', nome: "Pintado", regiao: ["Sul_MG","Paran치","S칚o Francisco","Pantanal"], tipo_agua: "Rio", isca: "Minhocu칞u, Tuvira", equip: "Vara 50lb", h: "Noite", p: "Po칞os" },
      { id: 'tucunare', nome: "Tucunar칠", regiao: ["Sul_MG","Paran치","Nordeste","Geral"], tipo_agua: "Represa", isca: "Artificial, Lambari", equip: "Vara 17lb", h: "Sol", p: "Estruturas" },
      { id: 'piapara', nome: "Piapara", regiao: ["Sul_MG","Paran치"], tipo_agua: "Rio", isca: "Milho, Caranguejo", equip: "Vara Sens칤vel", h: "Dia", p: "Cevas" },
      { id: 'traira', nome: "Tra칤ra", regiao: ["Geral"], tipo_agua: "Geral", isca: "Frog, Lambari", equip: "Vara 17lb", h: "Crep칰sculo", p: "Vegeta칞칚o" },
      { id: 'tilapia', nome: "Til치pia", regiao: ["Geral"], tipo_agua: "Geral", isca: "Massa, Ra칞칚o", equip: "Vara Telesc칩pica", h: "Dia", p: "Margens" },
      { id: 'mandi', nome: "Mandi", regiao: ["Geral"], tipo_agua: "Geral", isca: "Minhoca", equip: "Vara Leve", h: "Noite/Chuva", p: "Fundo" },
      { id: 'piau', nome: "Piau / Piapara", regiao: ["Geral"], tipo_agua: "Rio", isca: "Milho, Massa", equip: "Vara 15lb", h: "Dia", p: "Correnteza" },
      { id: 'curimba', nome: "Curimba", regiao: ["Geral"], tipo_agua: "Rio", isca: "Massa Doce", equip: "Vara M칠dia", h: "Dia", p: "Fundo/Barro" },
      { id: 'pacu', nome: "Pacu", regiao: ["Sul_MG","Paran치"], tipo_agua: "Geral", isca: "Coquinho, Massa", equip: "Vara 25lb", h: "Dia", p: "Fundo" },
      { id: 'tambaqui', nome: "Tambaqui", regiao: ["Norte","Nordeste","Geral"], tipo_agua: "Represa", isca: "Salsicha", equip: "Vara Pesada", h: "Dia", p: "Superf칤cie" }
    ];

    // --- GAVETA ---
    const drawer = document.getElementById('painel');
    const handle = document.getElementById('drag-handle');
    let startY = 0, startH = 0;

    handle.addEventListener('touchstart', e => { startY = e.touches[0].clientY; startH = drawer.offsetHeight; });
    handle.addEventListener('touchmove', e => {
      const delta = startY - e.touches[0].clientY;
      const newH = Math.min(window.innerHeight * 0.9, Math.max(300, startH + delta));
      drawer.style.height = `${newH}px`;
    });
    handle.addEventListener('touchend', () => {
      if (drawer.offsetHeight > 400) drawer.classList.add('open');
      else { drawer.classList.remove('open'); drawer.style.height = '300px'; }
    });

    // --- L칍GICA PRINCIPAL ---
    async function atualizarDados(lat, lng) {
      // 1. Busca Local (Nominatim)
      const geoUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`;
      const geoRes = await fetch(geoUrl).then(r => r.json());
      const addr = geoRes.address || {};
      
      // Nome Inteligente: Tenta achar o melhor nome poss칤vel
      const nomeLocal = addr.city || addr.town || addr.village || addr.municipality || addr.county || "Local Remoto";
      const uf = addr.state ? (UF_MAP[addr.state] || "BR") : "BR";
      document.getElementById('lbl-cidade').innerText = `${nomeLocal}-${uf}`;

      // 2. Busca Clima (Open-Meteo)
      const wUrl = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,precipitation,weathercode`;
      const wRes = await fetch(wUrl).then(r => r.json());
      const cur = wRes.current;

      // Atualiza Clima na Tela
      document.getElementById('val-temp').innerText = `${Math.round(cur.temperature_2m)}춿C`;
      document.getElementById('val-vento').innerText = `${Math.round(cur.wind_speed_10m)} km/h`;
      document.getElementById('val-press').innerText = `${Math.round(cur.surface_pressure)} hPa`;
      document.getElementById('val-chuva').innerText = `${cur.precipitation} mm`;
      document.getElementById('val-hum').innerText = `${cur.relative_humidity_2m}%`;
      document.getElementById('val-lua').innerText = getLua();

      // 3. Detecta Rio/Represa Pr칩ximo (Raio 10km - AUMENTADO)
      const riverQuery = `[out:json];(way["waterway"~"river|canal"](around:10000,${lat},${lng});relation["water"~"lake|reservoir"](around:10000,${lat},${lng}););out tags center;`;
      const riverRes = await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(riverQuery)}`).then(r => r.json()).catch(()=>({elements:[]}));
      
      let nomeRio = "";
      let isRepresa = false;
      let isRioGrande = false;

      if(riverRes.elements && riverRes.elements.length > 0) {
        // Pega o primeiro corpo d'치gua com nome
        const corpo = riverRes.elements.find(e => e.tags.name);
        if(corpo) {
          nomeRio = corpo.tags.name;
          document.getElementById('lbl-rio').innerText = `游늸 Pr칩ximo: ${nomeRio}`;
          
          const rUp = nomeRio.toUpperCase();
          if(rUp.includes("REPRESA") || rUp.includes("LAGO") || rUp.includes("BARRAGEM")) isRepresa = true;
          if(rUp.includes("RIO GRANDE") || rUp.includes("PARAN츼")) isRioGrande = true;
        } else {
          document.getElementById('lbl-rio').innerText = "游늸 Rio/Lago sem nome detectado";
        }
      } else {
        document.getElementById('lbl-rio').innerText = "";
      }

      // 4. Define a Regi칚o de Pesca
      let regiaoPesca = "Geral";
      if(uf === "MG") {
        if(lat < -18.5) regiaoPesca = "Sul_MG"; // Sul de Minas
        else regiaoPesca = "Norte_MG"; // S칚o Francisco
      } else if(["SP","PR","MS"].includes(uf)) regiaoPesca = "Paran치";
      else if(["BA","PE","AL","SE","PI","CE","RN"].includes(uf)) regiaoPesca = "Nordeste";
      
      document.getElementById('badge-bacia').innerText = regiaoPesca.replace("_"," ").toUpperCase();

      // 5. Filtra e Pontua os Peixes
      const lista = PEIXES_DB.filter(p => {
        // Regra: O peixe deve ser da regi칚o OU ser Geral
        return p.regiao.includes(regiaoPesca) || p.regiao.includes("Geral");
      }).map(p => {
        let score = 80; // Base alta

        // Se o peixe 칠 de Represa e N츾O tem represa perto -> Penaliza, mas n칚o mata (agora aparece com score menor)
        if(p.tipo_agua === "Represa" && !isRepresa) score -= 30;
        
        // Se o peixe 칠 de Rio Grande e estamos num afluente -> Penaliza leve
        if(p.tipo_agua === "Rio" && !isRioGrande) score -= 10;

        // Ajuste Clima
        score -= Math.abs(cur.temperature_2m - 25) * 2; // Penalidade temp

        return {...p, score: Math.max(20, Math.min(99, Math.round(score))) };
      }).sort((a,b) => b.score - a.score);

      // Renderiza
      renderizarLista(lista);
    }

    function renderizarLista(lista) {
      const chips = document.getElementById('chips-container');
      const feed = document.getElementById('lista-peixes');
      chips.innerHTML = ""; feed.innerHTML = "";

      // Top 3
      lista.slice(0,3).forEach(p => {
        chips.innerHTML += `<div class="chip"><div class="dot" style="background:${getCor(p.score)}"></div>${p.nome}</div>`;
      });

      // Lista Completa
      lista.forEach(p => {
        feed.innerHTML += `
          <div class="fish-card">
            <div class="card-head">
              <span class="f-name">${p.nome}</span>
              <span class="f-score" style="background:${getCorBg(p.score)}; color:${getCorTxt(p.score)}">${p.score}%</span>
            </div>
            <div class="tech-info">
              <div class="info-box"><span class="ib-lbl">ISCA</span><span class="ib-val">${p.isca}</span></div>
              <div class="info-box"><span class="ib-lbl">ONDE</span><span class="ib-val">${p.p}</span></div>
              <div class="info-box" style="grid-column:span 2"><span class="ib-lbl">EQUIPAMENTO</span><span class="ib-val">${p.equip}</span></div>
            </div>
          </div>
        `;
      });
      
      document.getElementById('splash').style.opacity = 0;
      setTimeout(()=>document.getElementById('splash').style.display='none', 500);
    }

    // --- AJUDANTES ---
    const UF_MAP = {"Acre":"AC","Alagoas":"AL","Amap치":"AP","Amazonas":"AM","Bahia":"BA","Cear치":"CE","Distrito Federal":"DF","Esp칤rito Santo":"ES","Goi치s":"GO","Maranh칚o":"MA","Mato Grosso":"MT","Mato Grosso do Sul":"MS","Minas Gerais":"MG","Par치":"PA","Para칤ba":"PB","Paran치":"PR","Pernambuco":"PE","Piau칤":"PI","Rio de Janeiro":"RJ","Rio Grande do Norte":"RN","Rio Grande do Sul":"RS","Rond칪nia":"RO","Roraima":"RR","Santa Catarina":"SC","S칚o Paulo":"SP","Sergipe":"SE","Tocantins":"TO"};
    
    function getLua() { const d = new Date(); const m = ["Nova","Crescente","Cheia","Minguante"]; return m[Math.floor((d.getDate()/7)) % 4]; }
    function getCor(s) { return s>70 ? '#4ade80' : (s>50 ? '#facc15' : '#f87171'); }
    function getCorBg(s) { return s>70 ? '#dcfce7' : (s>50 ? '#fef9c3' : '#fee2e2'); }
    function getCorTxt(s) { return s>70 ? '#166534' : (s>50 ? '#854d0e' : '#991b1b'); }

    // --- EVENTOS ---
    map.on('moveend', () => {
      const c = map.getCenter();
      if(Math.abs(c.lat - lastLat) > 0.01) {
        lastLat = c.lat;
        document.getElementById('lbl-cidade').innerText = "Buscando...";
        atualizarDados(c.lat, c.lng);
      }
    });

    function usarGPS() {
      const btn = document.getElementById('gps-btn'); btn.classList.add('loading');
      navigator.geolocation.getCurrentPosition(p => {
        btn.classList.remove('loading');
        map.setView([p.coords.latitude, p.coords.longitude], 13);
      }, () => { btn.classList.remove('loading'); alert("Ative o GPS"); });
    }

    function buscarManual() {
      const q = document.getElementById('search-input').value;
      if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}, Brazil`).then(r=>r.json()).then(d=>{
        if(d[0]) map.setView([d[0].lat, d[0].lon], 12);
        else alert("Local n칚o encontrado");
      });
    }

    // In칤cio
    window.onload = () => usarGPS();
  </script>
</body>
</html>
