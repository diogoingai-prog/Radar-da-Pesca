<!DOCTYPE html>
<html lang="pt-pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Radar da Pesca üì°</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --accent: #38bdf8; --bg: #0f172a; --card: #ffffff; --price: #16a34a; --status-red: #dc2626; --badge-green: #10b981; }
    body { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--bg); overflow: hidden; color: #1e293b; -webkit-tap-highlight-color: transparent; }
    
    /* --- SPLASH SCREEN COM TRAVA DE SEGURAN√áA --- */
    #splash {
      position: fixed; inset: 0; background: var(--bg); z-index: 9999;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.8s ease-out, visibility 0.8s;
    }
    .radar-container { position: relative; width: 220px; height: 220px; }
    .radar-rings circle { fill: none; stroke: rgba(56, 189, 248, 0.15); stroke-width: 1; }
    .radar-scan-line { transform-origin: 100px 100px; animation: scan-anim-reverse 4s linear infinite; }
    .radar-target { fill: var(--accent); animation: slow-pulse 3s ease-in-out infinite; }
    @keyframes scan-anim-reverse { 0% { transform: rotate(360deg); } 100% { transform: rotate(0deg); } }
    @keyframes slow-pulse { 0%, 100% { opacity: 0.1; r: 1.5; } 50% { opacity: 0.9; r: 2.2; } }
    .splash-title { color: #fff; font-size: 26px; font-weight: 900; letter-spacing: 5px; margin: 25px 0 5px 0; text-align: center; }
    .splash-sub { color: var(--accent); font-size: 11px; font-weight: 600; text-transform: uppercase; text-align: center; padding: 0 25px; opacity: 0.8; }

    #map { height: 100vh; width: 100vw; z-index: 1; background: #e5e7eb; }
    .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none; opacity: 0.6; color: #0f172a; display: flex; align-items: center; justify-content: center; }

    .top-bar { position: absolute; top: 15px; left: 15px; right: 15px; z-index: 2000; }
    .search-box { background: #fff; border-radius: 25px; padding: 10px 18px; display: flex; align-items: center; gap: 10px; box-shadow: 0 6px 20px rgba(0,0,0,0.12); }
    .search-input { border: none; background: transparent; outline: none; width: 100%; font-size: 15px; color: #475569; font-weight: 500; }

    .gps-btn { position: absolute; bottom: 280px; right: 20px; z-index: 2500; background: #fff; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border: 2px solid #e0f2fe; color: #1d4ed8; cursor: pointer; }
    .gps-btn.loading { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* --- GAVETA --- */
    .drawer { 
      position: absolute; bottom: 0; left: 0; right: 0; z-index: 2000; 
      background: var(--card); border-radius: 24px 24px 0 0; 
      box-shadow: 0 -10px 40px rgba(0,0,0,0.15); 
      height: 230px; max-height: 94vh;
      transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1); 
      display: flex; flex-direction: column; overflow: hidden;
      touch-action: none;
    }
    .drawer.open { height: 94vh; }
    .drawer.dragging { transition: none; }
    .handle { height: 32px; width: 100%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; cursor: grab; }
    .handle-bar { width: 45px; height: 5px; background: #e2e8f0; border-radius: 10px; }

    .summary { padding: 0 20px 10px 20px; flex-shrink: 0; }
    .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .status-badge { font-size: 8px; font-weight: 800; color: var(--status-red); text-transform: uppercase; }
    .water-badge { font-size: 8px; font-weight: 900; background: var(--badge-green); color: #fff; padding: 2px 10px; border-radius: 20px; text-transform: uppercase; }
    .city-label { font-size: 20px; font-weight: 800; color: #0f172a; margin: 0 0 10px 0; }

    .env-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px; }
    .env-box { background: #f1f5f9; padding: 8px 4px; border-radius: 10px; text-align: center; }
    .env-lbl { display: block; font-size: 7px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
    .env-val { font-size: 11px; font-weight: 800; color: #0f172a; }

    .top3-row { display: flex; gap: 8px; overflow-x: auto; scrollbar-width: none; min-height: 38px; margin-bottom: 15px; }
    .fish-chip { background: #0f172a; color: #fff; padding: 10px 16px; border-radius: 12px; display: flex; align-items: center; gap: 5px; white-space: nowrap; font-size: 12px; font-weight: 600; }
    .fish-chip .status-tag { font-size: 7px; font-weight: 900; background: var(--accent); color: #0f172a; padding: 1px 4px; border-radius: 3px; }

    .details-title { font-size: 10px; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin: 0 20px 20px 20px; border-top: 1px solid #f1f5f9; padding-top: 15px; flex-shrink: 0; }
    .scroll-area { overflow-y: auto; flex: 1; background: #fff; -webkit-overflow-scrolling: touch; padding: 0 20px 250px 20px; touch-action: pan-y; }

    .fish-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 20px; padding: 20px; margin-bottom: 15px; }
    .tech-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 15px; }
    .tech-item { background: #fff; padding: 10px; border-radius: 12px; border-left: 4px solid var(--accent); position: relative; }
    .tech-item.gold { border-left-color: #f59e0b; }
    .buy-link { position: absolute; right: 8px; top: 8px; color: var(--price); font-size: 7px; font-weight: 900; text-transform: uppercase; text-decoration: none; }
    .tech-lbl { display: block; font-size: 8px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; }
    .tech-val { font-size: 12px; font-weight: 700; color: #0f172a; line-height: 1.4; }
    .footer-msg { text-align: center; padding: 40px 20px; color: #94a3b8; font-size: 11px; font-weight: 600; }
  </style>
</head>
<body>

  <div id="splash">
    <div class="radar-container">
      <svg viewBox="0 0 200 200" width="220" height="220">
        <g class="radar-rings"><circle cx="100" cy="100" r="98"/><circle cx="100" cy="100" r="75"/><circle cx="100" cy="100" r="50"/></g>
        <circle cx="135" cy="65" r="2.2" class="radar-target" />
        <g class="radar-scan-line"><path d="M 100 100 L 100 0 A 100 100 0 0 1 200 100 Z" fill="rgba(56, 189, 248, 0.2)"/><line x1="100" y1="100" x2="100" y2="0" stroke="#38bdf8" stroke-width="2.5"/></g>
      </svg>
    </div>
    <h1 class="splash-title">RADAR DA PESCA</h1>
    <p class="splash-sub">Veja em tempo real qual peixe est√° no radar para sua pescaria</p>
  </div>

  <div class="top-bar"><div class="search-box"><span class="material-icons" style="color:#94a3b8">search</span><input type="text" id="search-input" class="search-input" placeholder="Pesquisar cidade ou rio..." onkeypress="if(event.key==='Enter') buscarManual()"><button onclick="buscarManual()" style="background:none; border:none; font-weight:900; color:#0f172a; cursor:pointer;">IR</button></div></div>
  <div class="gps-btn" id="gps-btn" onclick="iniciarGPS()"><span class="material-icons">my_location</span></div>
  <div id="map"></div>
  <div class="crosshair"><span class="material-icons" style="font-size: 28px;">add</span></div>

  <div class="drawer" id="painel">
    <div class="handle" id="drawer-handle"><div class="handle-bar"></div></div>
    <div class="summary" id="drawer-summary">
      <div class="header-row"><div class="status-badge"><span class="material-icons" style="font-size:10px; vertical-align:middle;">sensors</span> RADAR OPERACIONAL</div><div class="water-badge">EXCLUSIVO √ÅGUA DOCE</div></div>
      <h2 class="city-label" id="lbl-cidade">üìç Localizando...</h2>
      <div class="env-grid">
        <div class="env-box"><span class="env-lbl">Temperatura</span><span class="env-val" id="val-temp">--</span></div>
        <div class="env-box"><span class="env-lbl">Vento</span><span class="env-val" id="val-vento">--</span></div>
        <div class="env-box"><span class="env-lbl">Press√£o</span><span class="env-val" id="val-press">--</span></div>
        <div class="env-box"><span class="env-lbl">Lua</span><span class="env-val" id="val-lua">--</span></div>
        <div class="env-box"><span class="env-lbl">Humidade</span><span class="env-val" id="val-hum">--</span></div>
        <div class="env-box"><span class="env-lbl">Chuva</span><span class="env-val" id="val-rain">--</span></div>
      </div>
      <div class="top3-row" id="container-top3"></div>
    </div>
    <div class="details-title">Estrat√©gia T√©cnica de Pesca</div>
    <div class="scroll-area" id="scroll-content"><div id="lista-detalhada"></div><div class="footer-msg">Radar da Pesca ‚Ä¢ Sua Intelig√™ncia em √Ågua Doce</div></div>
  </div>

  <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
  <script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-15.7, -47.9], 5);
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}').addTo(map);

    let lastCoords = { lat: 0, lng: 0 };
    const UF_MAP = {"Acre":"AC","Alagoas":"AL","Amap√°":"AP","Amazonas":"AM","Bahia":"BA","Cear√°":"CE","Distrito Federal":"DF","Esp√≠rito Santo":"ES","Goi√°s":"GO","Maranh√£o":"MA","Mato Grosso":"MT","Mato Grosso do Sul":"MS","Minas Gerais":"MG","Par√°":"PA","Para√≠ba":"PB","Paran√°":"PR","Pernambuco":"PE","Piau√≠":"PI","Rio de Janeiro":"RJ","Rio Grande do Norte":"RN","Rio Grande do Sul":"RS","Rond√¥nia":"RO","Roraima":"RR","Santa Catarina":"SC","S√£o Paulo":"SP","Sergipe":"SE","Tocantins":"TO"};

    const PEIXES_DB = [
      { id: 'tilapia', nome: "Til√°pia", bacia: ["Paran√°","S√£o Francisco","Geral"], isca: "Massa ou Ra√ß√£o furada", idealT: 22, h: "Manh√£/Tarde", prof: "1-3m", p: "Margens/Cevas", vara: "12lb Telesc√≥pica", linha: "0.25mm Mono" },
      { id: 'traira', nome: "Tra√≠ra", bacia: ["Geral"], isca: "Frog ou Lambari", idealT: 23, h: "Crep√∫sculo", prof: "Raso", p: "Vegeta√ß√£o", vara: "17lb A√ß√£o R√°pida", linha: "0.25mm Multi" },
      { id: 'dourado', nome: "Dourado", bacia: ["Paran√°","Paraguai","Uruguai","S√£o Francisco"], isca: "Tuvira ou Plugs", idealT: 24, h: "Dia todo", prof: "Meia √Ågua", p: "Corredeiras", vara: "40lb R√°pida", linha: "0.40mm Multi" },
      { id: 'piapara', nome: "Piapara", bacia: ["Paran√°","Paraguai"], isca: "Milho ou Caranguejo", idealT: 24, h: "Manh√£", prof: "4-8m", p: "Po√ßos ceifados", vara: "20lb M√©dia", linha: "0.35mm Mono" },
      { id: 'tucunare', nome: "Tucunar√© Azul", bacia: ["Paran√°","Araguaia","Tocantins"], isca: "Zaras ou Sticks", idealT: 27, h: "10h - 16h", prof: "0.2-2m", p: "Troncos", vara: "20lb R√°pida", linha: "0.28mm Multi" }
    ];

    const drawer = document.getElementById('painel');
    const scrollContent = document.getElementById('scroll-content');
    let startY = 0, startH = 0, isDragging = false;
    const minH = 230, maxH = window.innerHeight * 0.94;

    const handleStart = (e) => {
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      if (drawer.offsetHeight >= maxH - 10 && scrollContent.scrollTop > 0) return;
      startY = clientY; startH = drawer.offsetHeight; isDragging = true;
    };

    const handleMove = (e) => {
      if (!isDragging) return;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      const deltaY = startY - clientY; 
      if (startH >= maxH - 10 && deltaY > 0) { isDragging = false; return; }
      let newH = startH + deltaY;
      if (newH > maxH) newH = maxH + (newH - maxH) * 0.1;
      if (newH < minH) newH = minH - (minH - newH) * 0.2;
      drawer.style.height = `${newH}px`;
      if (e.cancelable) e.preventDefault();
    };

    const handleEnd = () => {
      isDragging = false;
      if (drawer.offsetHeight > minH + 70) { drawer.style.height = `${maxH}px`; drawer.classList.add('open'); }
      else { drawer.style.height = `${minH}px`; drawer.classList.remove('open'); scrollContent.scrollTop = 0; }
    };

    drawer.addEventListener('touchstart', handleStart, { passive: true });
    window.addEventListener('touchmove', handleMove, { passive: false });
    window.addEventListener('touchend', handleEnd);

    function getMoonData() {
      const lp = 2551443; const age = Math.floor(((new Date().getTime() - new Date(1970, 0, 7, 20, 35, 0).getTime()) / 1000) % lp / (24 * 3600)) + 1;
      if (age <= 3) return {n: "Nova", i: "‚óè"}; if (age <= 13) return {n: "Crescente", i: "‚òΩ"};
      if (age <= 17) return {n: "Cheia", i: "‚óè"}; return {n: "Minguante", i: "‚òæ"};
    }

    async function rodarRadar(coords) {
      if (Math.abs(coords.lat - lastCoords.lat) < 0.005) return;
      lastCoords = coords;
      try {
        const pGeo = fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coords.lat}&lon=${coords.lng}`).then(r => r.json());
        const pWeather = fetch(`https://api.open-meteo.com/v1/forecast?latitude=${coords.lat}&longitude=${coords.lng}&current=temperature_2m,relative_humidity_2m,surface_pressure,wind_speed_10m,precipitation&timezone=auto`).then(r => r.json());

        const [resGeo, resW] = await Promise.all([pGeo, pWeather]);
        const addr = resGeo.address || {};
        const fullAddr = JSON.stringify(addr).toLowerCase();
        const uf = UF_MAP[addr.state] || "BR";
        const cid = addr.city || addr.town || addr.village || "Local";
        document.getElementById('lbl-cidade').innerText = `üìç ${cid}-${uf}`;

        let bacia = "Desconhecida";
        if (fullAddr.includes("amazon") || ["AM","PA","RO","RR","AC","AP"].includes(uf)) bacia = "Amazonas";
        else if (fullAddr.includes("francisco") || ["MG","BA","PE","AL","SE"].includes(uf)) bacia = "S√£o Francisco";
        else if (fullAddr.includes("parana") || fullAddr.includes("tiet") || ["MS","PR","SP","SC"].includes(uf)) bacia = "Paran√°";

        const cur = resW.current;
        const moon = getMoonData();

        document.getElementById('val-temp').innerText = `${Math.round(cur.temperature_2m)}¬∞C`;
        document.getElementById('val-vento').innerText = `${Math.round(cur.wind_speed_10m)}km/h`;
        document.getElementById('val-press').innerText = `${Math.round(cur.surface_pressure)}hPa`;
        document.getElementById('val-lua').innerHTML = `<span style="margin-right:4px">${moon.i}</span> ${moon.n}`;
        document.getElementById('val-hum').innerText = `${cur.relative_humidity_2m}%`;
        document.getElementById('val-rain').innerText = `${cur.precipitation.toFixed(1)}mm`;

        const top3C = document.getElementById('container-top3');
        const listC = document.getElementById('lista-detalhada');
        top3C.innerHTML = ''; listC.innerHTML = '';
        
        const sortedFish = PEIXES_DB.filter(p => p.bacia.includes(bacia) || p.bacia.includes("Geral"))
        .map(p => {
          let score = 75 - Math.abs(cur.temperature_2m - p.idealT) * 4;
          if(moon.n === "Cheia") score += 10;
          return {...p, score};
        }).sort((a,b) => b.score - a.score);

        sortedFish.slice(0,3).forEach(p => {
          top3C.innerHTML += `<div class="fish-chip">${p.nome} <span class="status-tag">BOM</span></div>`;
        });

        sortedFish.forEach(p => {
          listC.innerHTML += `
            <div class="fish-card">
              <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:800; font-size:17px; color:#0f172a;">${p.nome}</span>
                <span style="font-size:9px; font-weight:800; background:#dcfce7; color:#15803d; padding:4px 10px; border-radius:10px;">PREVIS√ÉO ALTA</span>
              </div>
              <div class="tech-grid">
                <div class="tech-item gold" style="grid-column: span 2;">
                  <span class="tech-lbl">Isca (Gatilho)</span><span class="tech-val">${p.isca}</span>
                </div>
                <div class="tech-item green"><span class="tech-lbl">Hor√°rio</span><span class="tech-val">${p.h}</span></div>
                <div class="tech-item green"><span class="tech-lbl">üåä Prof.</span><span class="tech-val">${p.prof}</span></div>
                <div class="tech-item"><span class="tech-lbl">Vara</span><span class="tech-val">${p.vara}</span></div>
                <div class="tech-item"><span class="tech-lbl">Linha</span><span class="tech-val">${p.linha}</span></div>
              </div>
            </div>`;
        });
        fecharSplash();
      } catch (e) { fecharSplash(); }
    }

    function fecharSplash() {
      const s = document.getElementById('splash');
      if(s) { s.style.opacity = '0'; setTimeout(() => s.style.display = 'none', 800); }
    }

    function iniciarGPS() {
      navigator.geolocation.getCurrentPosition((pos) => {
        const c = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.flyTo([c.lat, c.lng], 13); rodarRadar(c);
      }, () => { rodarRadar(map.getCenter()); fecharSplash(); });
    }
    
    function buscarManual() {
      const q = document.getElementById('search-input').value;
      if(!q) return;
      fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`).then(r => r.json()).then(data => { if(data[0]) { const c = {lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon)}; map.setView([c.lat, c.lng], 12); rodarRadar(c); } });
    }

    window.onload = () => { 
      iniciarGPS(); 
      setTimeout(fecharSplash, 5000); // V√ÅLVULA DE SEGURAN√áA: FECHA AP√ìS 5s SEMPRE
    };
  </script>
</body>
</html>

